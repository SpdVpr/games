<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Survivor</title>
    <style>
        /* Styly pro vzhled hry */
        body {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #eee; overflow: hidden;
        }
        canvas {
            border: 2px solid #888; background-color: #282c34; cursor: crosshair;
             /* Vypnutí vyhlazování pro pixel art vzhled */
             image-rendering: pixelated;
             image-rendering: -moz-crisp-edges;
             image-rendering: crisp-edges;
        }
        #ui-container {
            margin-top: 10px; width: 800px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; flex-wrap: wrap;
        }
        .ui-item { margin: 5px 10px; }
        #xp-bar-container {
            width: 200px; height: 20px; background-color: #444; border: 1px solid #666; border-radius: 5px; overflow: hidden;
        }
        #xp-bar {
            width: 0%; height: 100%; background-color: #4caf50; transition: width 0.2s ease-in-out;
        }
        #level-up-screen, #game-over-screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(20, 20, 20, 0.95); padding: 30px; border-radius: 10px;
            text-align: center; display: none; z-index: 10; border: 2px solid #aaa; color: #eee; min-width: 300px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #level-up-screen h2, #game-over-screen h2 {
            margin-top: 0; margin-bottom: 15px;
        }
        #game-over-screen {
            background-color: rgba(50, 0, 0, 0.95); border-color: #f44336; color: #fdd;
        }
        .upgrade-button, #restart-button {
            display: block; background-color: #4CAF50; color: white; padding: 12px 20px; margin: 10px auto;
            border: none; border-radius: 5px; cursor: pointer; font-size: 1em; min-width: 250px; transition: background-color 0.2s;
            text-align: left; /* Zarovnání textu v tlačítku */
            line-height: 1.4;
        }
         /* Styl pro popis vylepšení */
         .upgrade-button small {
            display: block; font-size: 0.85em; color: #ccc; margin-top: 3px;
        }
        .upgrade-button:hover { background-color: #45a049; }
        #restart-button {
            background-color: #f44336; font-size: 1.1em; min-width: 150px; text-align: center;
        }
        #restart-button:hover { background-color: #d32f2f;}
        #timer { font-size: 1.2em; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Pixel Survivor</h1>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="ui-container">
        <span class="ui-item">Zdraví: <span id="health">100</span></span>
        <span class="ui-item">Úroveň: <span id="level">1</span></span>
        <div class="ui-item" id="xp-bar-container"><div id="xp-bar"></div></div>
        <span class="ui-item">XP: <span id="xp-value">0</span> / <span id="xp-needed">10</span></span>
        <span class="ui-item">Čas: <span id="timer">0:00</span></span>
    </div>

    <!-- Obrazovka pro výběr vylepšení -->
    <div id="level-up-screen">
        <h2>Postup na další úroveň!</h2>
        <p>Vyber si vylepšení:</p>
        <div id="upgrade-options"></div>
    </div>

    <!-- Obrazovka pro konec hry -->
    <div id="game-over-screen">
        <h2>Konec hry!</h2>
        <p>Přežil jsi <span id="final-time">0:00</span></p>
        <p>Dosáhl jsi úrovně <span id="final-level">1</span></p>
        <button id="restart-button">Hrát znovu</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        // Vypnutí vyhlazování pro pixel art vzhled
        ctx.imageSmoothingEnabled = false;

        // --- UI Prvky ---
        const healthDisplay = document.getElementById('health');
        const levelDisplay = document.getElementById('level');
        const xpBar = document.getElementById('xp-bar');
        const xpValueDisplay = document.getElementById('xp-value');
        const xpNeededDisplay = document.getElementById('xp-needed');
        const levelUpScreen = document.getElementById('level-up-screen');
        const upgradeOptionsContainer = document.getElementById('upgrade-options');
        const gameOverScreen = document.getElementById('game-over-screen');
        const restartButton = document.getElementById('restart-button');
        const timerDisplay = document.getElementById('timer');
        const finalTimeDisplay = document.getElementById('final-time');
        const finalLevelDisplay = document.getElementById('final-level');

        // --- Herní Konstanty ---
        const PIXEL_SCALE = 3; // Jak velký bude jeden "pixel" spritu na plátně
        const PROJECTILE_SIZE = 8;
        const XP_ORB_SIZE = 6;
        const PLAYER_BASE_SPEED = 2.5;
        const ENEMY_BASE_SPEED = 1;
        const PROJECTILE_SPEED = 6;
        const PROJECTILE_MAX_BOUNCES = 1;
        const ENEMY_SPAWN_RATE_START = 80; // Snímků mezi spawny na začátku
        const ENEMY_SPAWN_RATE_MIN = 25;   // Minimální počet snímků mezi spawny
        const ENEMY_HEALTH_START = 10;    // Základní zdraví nepřátel
        const ENEMY_DAMAGE = 10;
        const XP_PER_ENEMY = 3;         // Základní XP za nepřítele
        const LEVEL_XP_BASE = 10;
        const LEVEL_XP_FACTOR = 1.5;
        const PLAYER_BASE_HEALTH = 100;
        const INVINCIBILITY_DURATION = 30; // Snímků neporazitelnosti po zásahu

        // --- Pixel Art Definice ---
        const SPRITES = {
            player: {
                size: 8, // Velikost spritu v pixelech
                colors: {'b': '#61dafb', 'e': '#ffffff', 'o': '#21252b', 's': '#444'}, // b=body, e=eye, o=outline, s=shadow
                map: [
                    "  oooo  ",
                    " ooBBoo ",
                    " oBeBeo ",
                    " oBBBBoo",
                    " ooBBBo ",
                    " oBsBBoo",
                    " ooosso ",
                    "  oooo  "
                ].map(row => row.toUpperCase()) // Použijeme velká písmena pro konzistenci mapy
            },
            slime: {
                size: 8,
                colors: {'r': '#f44336', 'e': '#ffffff', 'o': '#5a0000', 'h': '#ff7961'}, // r=red, e=eye, o=outline, h=highlight
                map: [
                    "  oooo  ",
                    " ooRRoo ",
                    " oReReo ",
                    " oRRRRoo",
                    " ohRRRRo",
                    " oRRRRoo",
                    " ooRRoo ",
                    "  oooo  "
                ].map(row => row.toUpperCase())
            },
            brute: {
                size: 10,
                colors: {'p': '#9c27b0', 'e': '#f1f1f1', 'o': '#3e004d', 's': '#6a0080'}, // p=purple, e=eye, o=outline, s=shade
                map: [
                    " ooooooooo",
                    " oPPPPPPPo",
                    " oPPePePPo",
                    " oPPPPPPPo",
                    " oPssssPPo",
                    " oPssssPPo",
                    " oPssssPPo",
                    " oPPPPPPPo",
                    " oPPPPPPPo",
                    " ooooooooo",
                ].map(row => row.toUpperCase())
            },
            flyer: {
                size: 6,
                colors: {'o': '#ff9800', 'w': '#ffffff', 'k': '#444444'}, // o=orange, w=wing, k=black
                map: [
                    " kkkk ",
                    "koookk",
                    "kwoowk",
                    "kwoowk",
                    "kkook ",
                    "  kk  "
                ].map(row => row.toUpperCase())
            }
        };

        // --- Typy Nepřátel ---
        const enemyTypes = [
            { id: 'slime', sprite: SPRITES.slime, healthMultiplier: 1.0, speedMultiplier: 1.0, xpMultiplier: 1.0 },
            { id: 'brute', sprite: SPRITES.brute, healthMultiplier: 2.5, speedMultiplier: 0.7, xpMultiplier: 1.5 },
            { id: 'flyer', sprite: SPRITES.flyer, healthMultiplier: 0.6, speedMultiplier: 1.4, xpMultiplier: 0.8 },
        ];

        // --- Herní Stav ---
        let player = {};
        let enemies = [];
        let projectiles = [];
        let xpOrbs = [];
        let keysPressed = {};
        let mousePos = { x: 0, y: 0 };
        let enemySpawnCooldown = ENEMY_SPAWN_RATE_START;
        let currentEnemySpawnRate = ENEMY_SPAWN_RATE_START;
        let currentEnemyHealthBase = ENEMY_HEALTH_START;
        let gameTime = 0;
        let gameTimerInterval;
        let isPaused = false;
        let isGameOver = false;
        let animationFrameId = null;
        let playerInvincibleTimer = 0;
        let currentUpgradeChoices = [];

        // --- Pomocné funkce ---
        function distance(x1, y1, x2, y2) { const dx = x1 - x2; const dy = y1 - y2; return Math.sqrt(dx * dx + dy * dy); }
        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function formatTime(seconds) { const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60); return `${min}:${sec.toString().padStart(2, '0')}`; }
        function getMousePos(canvas, evt) { const rect = canvas.getBoundingClientRect(); return { x: evt.clientX - rect.left, y: evt.clientY - rect.top }; }

        // --- Inicializace a Restart ---
        function resetPlayerState() {
            const sprite = SPRITES.player;
            const sizeOnCanvas = sprite.size * PIXEL_SCALE;
             player = {
                x: canvas.width / 2 - sizeOnCanvas / 2,
                y: canvas.height / 2 - sizeOnCanvas / 2,
                sprite: sprite,
                size: sizeOnCanvas, // Velikost na canvasu pro kolize
                baseSize: sprite.size, // Velikost spritu v pixelech
                speed: PLAYER_BASE_SPEED,
                health: PLAYER_BASE_HEALTH,
                maxHealth: PLAYER_BASE_HEALTH,
                level: 1,
                xp: 0,
                xpToNextLevel: LEVEL_XP_BASE,
                color: '#61dafb', // Záložní barva
                weapons: [
                    // Startovní zbraň
                    { id: 'pistol', level: 1, cooldown: 0, baseFireRate: 40, baseDamage: 10, projectilesPerShot: 1 }
                ],
                // Globální modifikátory statistik
                statModifiers: {
                    fireRateMultiplier: 1.0,
                    damageMultiplier: 1.0,
                    areaMultiplier: 1.0, // Pro zbraně jako Aura
                }
            };
        }

        function resetGameState() {
            resetPlayerState();
            enemies = []; projectiles = []; xpOrbs = []; keysPressed = {};
            mousePos = { x: player.x + player.size / 2, y: player.y + player.size / 2 }; // Start mouse pos near player
            enemySpawnCooldown = ENEMY_SPAWN_RATE_START;
            currentEnemySpawnRate = ENEMY_SPAWN_RATE_START;
            currentEnemyHealthBase = ENEMY_HEALTH_START;
            gameTime = 0; isPaused = false; isGameOver = false; playerInvincibleTimer = 0; currentUpgradeChoices = [];

            // Reset UI
            healthDisplay.textContent = player.health;
            levelDisplay.textContent = player.level;
            xpValueDisplay.textContent = player.xp; xpNeededDisplay.textContent = player.xpToNextLevel;
            xpBar.style.width = '0%'; timerDisplay.textContent = formatTime(gameTime);
            levelUpScreen.style.display = 'none'; gameOverScreen.style.display = 'none';
        }

        function startGame() {
            resetGameState();
            // Start časovače
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                 if (!isPaused && !isGameOver) {
                    gameTime++;
                    timerDisplay.textContent = formatTime(gameTime);
                    // Ztěžování hry
                    currentEnemySpawnRate = Math.max(ENEMY_SPAWN_RATE_MIN, ENEMY_SPAWN_RATE_START - Math.floor(gameTime / 4));
                    currentEnemyHealthBase = ENEMY_HEALTH_START + Math.floor(gameTime / 8);
                }
            }, 1000);
            // Start herní smyčky
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        }

        // --- Herní Smyčka ---
        function gameLoop() {
             animationFrameId = requestAnimationFrame(gameLoop); // Požadavek na další frame
             if (isGameOver) return; // Pokud konec, nedělej nic
             if (isPaused) return; // Pokud pauza, nedělej nic

             update(); // Aktualizuj stav hry
             draw();   // Vykresli hru
         }

        // --- Aktualizační Funkce ---
        function update() {
            updatePlayer();
            handleWeaponFiring(); // Zpracuje střelbu všech aktivních zbraní
            updateProjectiles(); // Pohyb a odrazy projektilů
            updateEnemies(); // Pohyb nepřátel
            updateXpOrbs(); // (zatím žádná logika)
            handleEnemySpawning(); // Vytváření nových nepřátel
            handleCollisions(); // Detekce a zpracování kolizí

            // Časovač neporazitelnosti hráče
            if (playerInvincibleTimer > 0) playerInvincibleTimer--;

            // Kontrola konce hry
            if (player.health <= 0 && !isGameOver) {
                isGameOver = true;
                showGameOver(); // Zobraz obrazovku konce hry
            }
        }

        function updatePlayer() {
            let dx = 0, dy = 0;
            if (keysPressed['arrowup'] || keysPressed['w']) dy -= 1;
            if (keysPressed['arrowdown'] || keysPressed['s']) dy += 1;
            if (keysPressed['arrowleft'] || keysPressed['a']) dx -= 1;
            if (keysPressed['arrowright'] || keysPressed['d']) dx += 1;

            // Normalizace pohybu (konstantní rychlost i diagonálně)
            const len = Math.sqrt(dx * dx + dy * dy);
            if (len > 0) {
                dx = (dx / len) * player.speed;
                dy = (dy / len) * player.speed;
            }

            player.x += dx;
            player.y += dy;

            // Omezení hráče v rámci plátna
            player.x = Math.max(0, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(0, Math.min(canvas.height - player.size, player.y));
         }

        // --- Zpracování Zbraní ---
        function handleWeaponFiring() {
            if (isPaused) return;

            const playerCenterX = player.x + player.size / 2;
            const playerCenterY = player.y + player.size / 2;

            player.weapons.forEach(weapon => {
                weapon.cooldown = (weapon.cooldown || 0) - 1; // Bezpečnější odečítání

                // Výpočet aktuálních statistik zbraně s modifikátory
                const fireRate = Math.max(5, (weapon.baseFireRate || 60) / player.statModifiers.fireRateMultiplier); // Omezení minimální kadence
                const damage = (weapon.baseDamage || 0) * player.statModifiers.damageMultiplier;
                const area = player.statModifiers.areaMultiplier;

                if (weapon.cooldown <= 0) {
                    // Reset cooldownu
                    weapon.cooldown = fireRate;

                    // Akce specifická pro zbraň
                    switch (weapon.id) {
                        case 'pistol': {
                            const numProjectiles = weapon.projectilesPerShot || 1;
                            const angleSpread = numProjectiles > 1 ? Math.PI / 18 : 0; // Rozptyl 10 stupňů mezi střelami
                            const baseDx = mousePos.x - playerCenterX;
                            const baseDy = mousePos.y - playerCenterY;
                            const baseDist = Math.sqrt(baseDx * baseDx + baseDy * baseDy) || 1;
                            const baseAngle = Math.atan2(baseDy, baseDx); // Úhel k myši

                            for (let i = 0; i < numProjectiles; i++) {
                                // Výpočet úhlu pro každou střelu s rozptylem
                                const currentAngle = baseAngle + (i - (numProjectiles - 1) / 2) * angleSpread;
                                const vx = Math.cos(currentAngle) * PROJECTILE_SPEED;
                                const vy = Math.sin(currentAngle) * PROJECTILE_SPEED;

                                projectiles.push({
                                    x: playerCenterX - PROJECTILE_SIZE / 2, y: playerCenterY - PROJECTILE_SIZE / 2,
                                    vx: vx, vy: vy, size: PROJECTILE_SIZE, damage: damage,
                                    color: '#ffeb3b', bounces: 0, maxBounces: PROJECTILE_MAX_BOUNCES
                                });
                            }
                            break; // Konec case 'pistol'
                        }
                        case 'aura': {
                            const auraRadius = (weapon.baseRadius || 60) * area;
                            // Najdi nepřátele v dosahu a uber jim životy
                            enemies.forEach(enemy => {
                                if (distance(playerCenterX, playerCenterY, enemy.x + enemy.size / 2, enemy.y + enemy.size / 2) < auraRadius) {
                                    enemy.health -= damage;
                                    // Vizuální efekt zásahu by byl zde nebo v draw()
                                    // Smrt nepřítele je řešena v handleCollisions, abychom předešli duplicitnímu kódu pro XP
                                }
                            });
                            // Vizuální efekt aury se kreslí v draw()
                            break; // Konec case 'aura'
                        }
                         case 'back_shot': {
                             // Střelí přímo opačným směrem, než je myš
                            const dx = playerCenterX - mousePos.x; // Opačný vektor X
                            const dy = playerCenterY - mousePos.y; // Opačný vektor Y
                            const dist = Math.sqrt(dx*dx + dy*dy) || 1; // Vzdálenost (nebo 1, aby se nedělilo nulou)
                            const vx = (dx / dist) * PROJECTILE_SPEED; // Normalizovaná rychlost X
                            const vy = (dy / dist) * PROJECTILE_SPEED; // Normalizovaná rychlost Y

                             projectiles.push({
                                x: playerCenterX - PROJECTILE_SIZE / 2, y: playerCenterY - PROJECTILE_SIZE / 2,
                                vx: vx, vy: vy, size: PROJECTILE_SIZE, damage: damage,
                                color: '#f06292', bounces: 0, maxBounces: 0 // Zadní střely se neodráží
                            });
                            break; // Konec case 'back_shot'
                         }
                         // Zde přidat case pro další zbraně...
                    }
                }
            });
        }

        function updateProjectiles() {
             for (let i = projectiles.length - 1; i >= 0; i--) {
                const p = projectiles[i];
                p.x += p.vx; p.y += p.vy;
                let bounced = false;

                // Odraz od stěn
                if (p.x <= 0 && p.vx < 0) { p.vx *= -1; p.x = 0; p.bounces++; bounced = true; }
                else if (p.x + p.size >= canvas.width && p.vx > 0) { p.vx *= -1; p.x = canvas.width - p.size; p.bounces++; bounced = true; }
                if (p.y <= 0 && p.vy < 0) { p.vy *= -1; p.y = 0; p.bounces++; bounced = true; }
                else if (p.y + p.size >= canvas.height && p.vy > 0) { p.vy *= -1; p.y = canvas.height - p.size; p.bounces++; bounced = true; }

                // Odstranit po max odrazech
                if (p.bounces > p.maxBounces) {
                    projectiles.splice(i, 1);
                }
            }
        }

        function handleEnemySpawning() {
            enemySpawnCooldown--;
            if (enemySpawnCooldown <= 0) {
                const typeTemplate = enemyTypes[getRandomInt(0, enemyTypes.length - 1)];
                const sprite = typeTemplate.sprite;
                const enemySizeOnCanvas = sprite.size * PIXEL_SCALE;

                // Spawn na náhodném okraji mimo viditelnou oblast
                const side = getRandomInt(0, 3); let spawnX, spawnY; const margin = 30;
                if (side === 0) { spawnX = Math.random() * canvas.width; spawnY = -enemySizeOnCanvas - margin; } // Top
                else if (side === 1) { spawnX = canvas.width + margin; spawnY = Math.random() * canvas.height; } // Right
                else if (side === 2) { spawnX = Math.random() * canvas.width; spawnY = canvas.height + margin; } // Bottom
                else { spawnX = -enemySizeOnCanvas - margin; spawnY = Math.random() * canvas.height; } // Left

                enemies.push({
                    x: spawnX, y: spawnY,
                    sprite: sprite,
                    size: enemySizeOnCanvas, // Velikost na canvasu
                    baseSize: sprite.size, // Velikost spritu
                    speed: (ENEMY_BASE_SPEED + Math.random() * 0.4) * typeTemplate.speedMultiplier,
                    maxHealth: Math.max(1, Math.floor(currentEnemyHealthBase * typeTemplate.healthMultiplier)),
                    health: Math.max(1, Math.floor(currentEnemyHealthBase * typeTemplate.healthMultiplier)),
                    damage: ENEMY_DAMAGE,
                    color: '#ff0000', // Fallback color
                    xpValue: Math.max(1, Math.floor(XP_PER_ENEMY * typeTemplate.xpMultiplier))
                });
                enemySpawnCooldown = currentEnemySpawnRate; // Reset cooldownu
            }
         }

        function updateEnemies() {
            // Pohyb nepřátel směrem k hráči
            enemies.forEach(enemy => {
                const playerCenterX = player.x + player.size / 2;
                const playerCenterY = player.y + player.size / 2;
                const enemyCenterX = enemy.x + enemy.size / 2;
                const enemyCenterY = enemy.y + enemy.size / 2;
                const dx = playerCenterX - enemyCenterX;
                const dy = playerCenterY - enemyCenterY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 0) { // Jen pokud není přímo na hráči
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                }
            });
        }

        function updateXpOrbs() { /* Zatím nic */ }

        // --- Kolize ---
        // Používá jednoduchou AABB (Axis-Aligned Bounding Box) kolizi
        function checkCollision(obj1, obj2) {
             return obj1.x < obj2.x + obj2.size &&
                    obj1.x + obj1.size > obj2.x &&
                    obj1.y < obj2.y + obj2.size &&
                    obj1.y + obj1.size > obj2.y;
        }

        function handleCollisions() {
             // Iterace od konce polí je bezpečnější při odstraňování prvků (splice)
             // Kolize Projektil -> Nepřítel
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const proj = projectiles[i]; if (!proj) continue; // Pokud byl projektil již odstraněn

                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j]; if (!enemy) continue; // Pokud byl nepřítel již odstraněn

                    if (checkCollision(proj, enemy)) {
                        enemy.health -= proj.damage;
                        projectiles.splice(i, 1); // Odstranit projektil po zásahu

                        if (enemy.health <= 0) {
                            // Nepřítel zemřel -> vytvoř XP orb
                            xpOrbs.push({
                                x: enemy.x + enemy.size / 2 - XP_ORB_SIZE / 2,
                                y: enemy.y + enemy.size / 2 - XP_ORB_SIZE / 2,
                                size: XP_ORB_SIZE,
                                value: enemy.xpValue, // Použij XP hodnotu nepřítele
                                color: '#4caf50' // Zelená pro XP
                            });
                            enemies.splice(j, 1); // Odstranit nepřítele z pole
                        }
                        break; // Projektil zasáhl, přejdi na další projektil (projektil nemůže zasáhnout více nepřátel najednou)
                    }
                }
            }

            // Kolize Hráč -> Nepřítel
            if (playerInvincibleTimer <= 0) { // Jen pokud hráč není neporazitelný
                for (let j = enemies.length - 1; j >= 0; j--) {
                     const enemy = enemies[j]; if (!enemy) continue;

                     if (checkCollision(player, enemy)) {
                        player.health -= enemy.damage; // Uber životy hráči
                        playerInvincibleTimer = INVINCIBILITY_DURATION; // Nastav neporazitelnost
                        healthDisplay.textContent = Math.max(0, player.health); // Aktualizuj UI

                        // Jednoduché odhození nepřítele
                        const knockbackStrength = 15;
                        const dx = player.x - enemy.x; const dy = player.y - enemy.y;
                        const dist = Math.sqrt(dx*dx + dy*dy) || 1; // || 1 zabrání dělení nulou
                        enemy.x -= (dx/dist) * knockbackStrength;
                        enemy.y -= (dy/dist) * knockbackStrength;

                        break; // Hráč může být zasažen jen jednou za frame pro férovost
                    }
                }
            }

            // Kolize Hráč -> XP Orb
             for (let k = xpOrbs.length - 1; k >= 0; k--) {
                 const orb = xpOrbs[k]; if (!orb) continue;

                 // Použijeme vzdálenost středů pro sběr, s větším dosahem
                 const pickupRadius = player.size / 2 + orb.size * 2;
                 if (distance(player.x + player.size / 2, player.y + player.size / 2,
                             orb.x + orb.size / 2, orb.y + orb.size / 2) < pickupRadius)
                 {
                    gainXP(orb.value); // Přidej XP
                    xpOrbs.splice(k, 1); // Odstraň orb
                 }
             }
        }

        // --- XP a Level Up ---
        function gainXP(amount) {
            if (isGameOver) return; // Nelze sbírat po smrti
            player.xp += amount;
            // Kontrola postupu na další úroveň
            if (player.xp >= player.xpToNextLevel) {
                levelUp();
            }
            updateXPUI(); // Aktualizuj ukazatel XP
        }

        function levelUp() {
            player.level++;
            const leftoverXp = player.xp - player.xpToNextLevel;
            player.xp = Math.max(0, leftoverXp); // Ponech přebytečné XP pro další úroveň
            player.xpToNextLevel = Math.floor(LEVEL_XP_BASE * Math.pow(LEVEL_XP_FACTOR, player.level - 1)); // Zvyš potřebu XP

            levelDisplay.textContent = player.level; // Aktualizuj UI
            updateXPUI();

            isPaused = true; // Pozastav hru
            showLevelUpOptions(); // Zobraz obrazovku s vylepšeními
        }

        function updateXPUI() {
             xpValueDisplay.textContent = player.xp;
             xpNeededDisplay.textContent = player.xpToNextLevel;
             // Omez procenta na 0-100%
             const xpPercentage = Math.max(0, Math.min(100, (player.xp / player.xpToNextLevel) * 100));
             xpBar.style.width = `${xpPercentage}%`;
         }

        // --- Systém Vylepšení ---
        const BASE_UPGRADES = [ // Základní vylepšení statistik
            { id: "health", name: "Více zdraví", description: "Zvýší max zdraví a plně vyléčí.", type: "stat", apply: () => { player.maxHealth += 25; player.health = player.maxHealth; healthDisplay.textContent = player.health;} },
            { id: "speed", name: "Rychlejší pohyb", description: "Zvýší rychlost pohybu hráče.", type: "stat", apply: () => player.speed += 0.4 },
            { id: "damage_mult", name: "Globální poškození +15%", description: "Zvýší veškeré udělené poškození.", type: "stat", apply: () => player.statModifiers.damageMultiplier += 0.15 },
            { id: "firerate_mult", name: "Globální kadence +15%", description: "Zvýší rychlost všech útoků.", type: "stat", apply: () => player.statModifiers.fireRateMultiplier += 0.15 },
            { id: "area_mult", name: "Globální dosah +20%", description: "Zvýší dosah/oblast některých útoků.", type: "stat", apply: () => player.statModifiers.areaMultiplier += 0.2 },
        ];

        const WEAPON_DEFINITIONS = { // Definice dostupných zbraní
            'pistol': { name: "Pistole", baseFireRate: 40, baseDamage: 10, projectilesPerShot: 1, maxLevel: 5, upgradeDesc: "Střel/Pošk./Kadence" },
            'aura': { name: "Aura", baseFireRate: 70, baseDamage: 5, baseRadius: 60, maxLevel: 5, upgradeDesc: "Pošk./Dosah/Interval" },
            'back_shot': { name: "Zadní výstřel", baseFireRate: 55, baseDamage: 8, maxLevel: 5, upgradeDesc: "Pošk./Kadence" },
        };

        // Generuje možné volby pro level up (přidání/vylepšení zbraní)
        function getWeaponUpgradeOptions() {
            let options = [];
            const ownedWeaponIds = player.weapons.map(w => w.id);

            // Nabídni přidání nových zbraní
            for (const weaponId in WEAPON_DEFINITIONS) {
                if (!ownedWeaponIds.includes(weaponId)) {
                    options.push({
                        id: `add_${weaponId}`, name: `Nová zbraň: ${WEAPON_DEFINITIONS[weaponId].name}`,
                        description: `Začneš používat tuto zbraň.`, type: 'weapon_add', weaponId: weaponId
                    });
                }
            }
            // Nabídni vylepšení existujících zbraní
            player.weapons.forEach(weapon => {
                const def = WEAPON_DEFINITIONS[weapon.id];
                if (weapon.level < def.maxLevel) {
                    options.push({
                        id: `upgrade_${weapon.id}`, name: `Vylepšit: ${def.name} (Lvl ${weapon.level + 1})`,
                        description: `Zlepšuje: ${def.upgradeDesc}`, type: 'weapon_upgrade', weaponId: weapon.id
                    });
                }
            });
            return options;
        }

        // Zobrazí obrazovku s výběrem vylepšení
        function showLevelUpOptions() {
            upgradeOptionsContainer.innerHTML = ''; // Vyčistit staré volby
            currentUpgradeChoices = []; // Vyčistit pole aktuálních voleb

            const allPossible = [...BASE_UPGRADES, ...getWeaponUpgradeOptions()];
            // Náhodně promíchat dostupné volby
             allPossible.sort(() => Math.random() - 0.5);

            const numOptions = Math.min(3, allPossible.length); // Zobrazit maximálně 3 volby

            // Vytvoř tlačítka pro volby
            for (let i = 0; i < numOptions; i++) {
                const upgrade = allPossible[i];
                currentUpgradeChoices.push(upgrade); // Ulož aktuální volby pro referenci

                const button = document.createElement('button');
                button.classList.add('upgrade-button');
                button.innerHTML = `${upgrade.name} <small>${upgrade.description}</small>`; // Použij innerHTML pro <small>
                button.onclick = () => selectUpgrade(i); // Při kliknutí zavolej selectUpgrade s indexem volby
                upgradeOptionsContainer.appendChild(button);
            }
             levelUpScreen.style.display = 'block'; // Zobraz obrazovku
        }

        // Zpracuje výběr vylepšení
         function selectUpgrade(choiceIndex) {
            const chosenUpgrade = currentUpgradeChoices[choiceIndex];
            if (!chosenUpgrade) return; // Pokud volba neexistuje, nedělej nic

            // Aplikuj vylepšení podle typu
            if (chosenUpgrade.type === 'stat') {
                chosenUpgrade.apply(); // Zavolej funkci pro aplikaci statistiky
            } else if (chosenUpgrade.type === 'weapon_add') {
                // Přidej novou zbraň do pole hráče
                const def = WEAPON_DEFINITIONS[chosenUpgrade.weaponId];
                player.weapons.push({
                     id: chosenUpgrade.weaponId, level: 1, cooldown: 0, // Start na levelu 1
                     // Nastav základní statistiky z definice
                     baseFireRate: def.baseFireRate, baseDamage: def.baseDamage,
                     projectilesPerShot: def.projectilesPerShot, baseRadius: def.baseRadius
                 });
            } else if (chosenUpgrade.type === 'weapon_upgrade') {
                // Najdi zbraň k vylepšení a zvyz její level
                const weaponToUpgrade = player.weapons.find(w => w.id === chosenUpgrade.weaponId);
                if (weaponToUpgrade) {
                    weaponToUpgrade.level++;
                    applyWeaponLevelBonuses(weaponToUpgrade); // Aplikuj bonusy za nový level
                }
            }

            levelUpScreen.style.display = 'none'; // Skryj obrazovku vylepšení
            isPaused = false; // Odpauzuj hru
        }

        // Aplikuje specifické bonusy zbraně na základě jejího levelu
        function applyWeaponLevelBonuses(weapon) {
             switch (weapon.id) {
                 case 'pistol':
                     weapon.projectilesPerShot = 1 + Math.floor((weapon.level - 1) / 2); // +1 střela na lvl 3 a 5
                     weapon.baseDamage = 10 + (weapon.level - 1) * 3; // +3 poškození za level
                     weapon.baseFireRate = 40 - (weapon.level - 1) * 3; // -3 cooldown za level (rychlejší)
                     break;
                 case 'aura':
                     weapon.baseDamage = 5 + (weapon.level - 1) * 2; // +2 poškození za level
                     weapon.baseRadius = 60 + (weapon.level - 1) * 10; // +10 dosah za level
                     weapon.baseFireRate = 70 - (weapon.level - 1) * 5; // -5 cooldown za level (rychlejší interval)
                     break;
                 case 'back_shot':
                      weapon.baseDamage = 8 + (weapon.level - 1) * 4; // +4 poškození za level
                      weapon.baseFireRate = 55 - (weapon.level - 1) * 5; // -5 cooldown za level (rychlejší)
                      break;
                  // Přidat case pro další zbraně...
             }
             // Zajistit, aby cooldown nebyl záporný nebo příliš nízký
             weapon.baseFireRate = Math.max(5, weapon.baseFireRate);
        }

        // --- Kreslící Funkce ---
        // --- Funkce pro kreslení pixel artu ---
        function drawPixelArt(sprite, x, y) {
            const { size, map, colors } = sprite;
            for (let r = 0; r < size; r++) { // Iteruj přes řádky spritu
                for (let c = 0; c < size; c++) { // Iteruj přes sloupce spritu
                    const char = map[r][c]; // Znak z mapy (VELKÝ)
                    const colorKey = char.toLowerCase(); // Převeď na malé písmeno pro hledání v barvách
                    const color = colors[colorKey]; // Najdi barvu
                    if (color) { // Pokud barva existuje (ignoruje mezery)
                        ctx.fillStyle = color; // Nastav barvu
                        // Vykresli zvětšený "pixel"
                        ctx.fillRect(
                            Math.floor(x + c * PIXEL_SCALE), // X pozice pixelu na canvasu
                            Math.floor(y + r * PIXEL_SCALE), // Y pozice pixelu na canvasu
                            PIXEL_SCALE,                     // Šířka pixelu
                            PIXEL_SCALE                      // Výška pixelu
                        );
                    }
                }
            }
        }

        // Hlavní kreslící funkce
        function draw() {
            // Vyčisti plátno
            ctx.fillStyle = '#282c34';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Kresli entity (od zadu dopředu)
            xpOrbs.forEach(orb => drawCircle(orb.x, orb.y, orb.size / 2, orb.color)); // XP orby
            projectiles.forEach(p => drawRect(p.x, p.y, p.size, p.size, p.color)); // Projektily
            drawEnemies(); // Nepřátele (pixel art)
            drawPlayer(); // Hráče (pixel art)

             // Vizuální efekt pro Auru (pokud ji hráč má)
            const auraWeapon = player.weapons.find(w => w.id === 'aura');
            if(auraWeapon && !isPaused) {
                const auraRadius = (auraWeapon.baseRadius || 60) * player.statModifiers.areaMultiplier;
                ctx.beginPath();
                ctx.arc(player.x + player.size / 2, player.y + player.size / 2, auraRadius, 0, Math.PI * 2);
                // Poloprůhledný kruh pro auru
                ctx.fillStyle = 'rgba(150, 200, 255, 0.08)'; // Velmi slabá výplň
                ctx.fill();
                // Slabý okraj aury
                ctx.strokeStyle = 'rgba(200, 220, 255, 0.15)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        // Kreslení hráče
        function drawPlayer() {
             if (playerInvincibleTimer > 0 && Math.floor(playerInvincibleTimer / 4) % 2 === 0) return; // Blikání při neporazitelnosti
             drawPixelArt(player.sprite, player.x, player.y); // Vykresli pixel art hráče
        }

        // Kreslení nepřátel
        function drawEnemies() {
             enemies.forEach(enemy => {
                drawPixelArt(enemy.sprite, enemy.x, enemy.y); // Vykresli pixel art nepřítele

                // Ukazatel zdraví nad nepřítelem
                if (enemy.health < enemy.maxHealth) {
                     const healthBarYOffset = 8; // Jak vysoko nad spritem
                     const healthBarWidth = enemy.size; // Šířka jako sprite
                     const healthBarHeight = 4; // Výška ukazatele
                     const healthPercentage = Math.max(0, enemy.health / enemy.maxHealth); // Procento zdraví (0-1)

                     // Pozadí ukazatele (tmavé)
                     ctx.fillStyle = '#555';
                     ctx.fillRect(enemy.x, enemy.y - healthBarYOffset, healthBarWidth, healthBarHeight);
                     // Aktuální zdraví (červené)
                     ctx.fillStyle = '#f44336';
                     ctx.fillRect(enemy.x, enemy.y - healthBarYOffset, healthBarWidth * healthPercentage, healthBarHeight);
                 }
            });
        }

        // Pomocné kreslící funkce pro projektily a XP
        function drawRect(x, y, width, height, color) { ctx.fillStyle = color; ctx.fillRect(x, y, width, height); }
        function drawCircle(x, y, radius, color) { ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x + radius, y + radius, radius, 0, Math.PI * 2); ctx.fill(); ctx.closePath(); }


        // --- Konec Hry ---
         function showGameOver() {
             if (gameTimerInterval) clearInterval(gameTimerInterval); // Zastav časovač
             // Herní smyčka se zastaví sama díky kontrole isGameOver na začátku gameLoop

             // Zobraz info na Game Over obrazovce
             finalTimeDisplay.textContent = formatTime(gameTime);
             finalLevelDisplay.textContent = player.level;
             gameOverScreen.style.display = 'block'; // Zobraz obrazovku
         }


        // --- Ovládání ---
        document.addEventListener('keydown', (e) => {
             // Zabraň posouvání stránky šipkami/WASD
             if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d"].includes(e.key)) {
                 e.preventDefault();
             }
            keysPressed[e.key.toLowerCase()] = true; // Ulož stisknutou klávesu (malým písmem)
        });
        document.addEventListener('keyup', (e) => {
            keysPressed[e.key.toLowerCase()] = false; // Označ klávesu jako puštěnou
        });
        // Sledování pozice myši
        canvas.addEventListener('mousemove', (evt) => {
            if (!isPaused && !isGameOver) { // Aktualizuj jen když hra běží
                mousePos = getMousePos(canvas, evt); // Získej pozici relativně ke canvasu
            }
        });

         // --- Restart ---
         // Při kliknutí na tlačítko restartuj hru
         restartButton.addEventListener('click', startGame);


        // --- Spuštění Hry ---
        // Spusť hru po načtení celé stránky
        window.onload = startGame;

    </script>

</body>
</html>
